name: Operator 0

on:
  issues:
    types: [opened]

jobs:
  answer-call:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Answer the call
        id: answer
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set +e  # Don't exit on error

          # Debug: check if API key is set
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ERROR: ANTHROPIC_API_KEY is not set"
            exit 1
          fi
          echo "API key is set (length: ${#ANTHROPIC_API_KEY})"

          # Run operator and capture response
          python operator0.py "$ISSUE_NUMBER" "$ISSUE_TITLE" "$ISSUE_BODY" 2>&1 | tee output.txt
          PYTHON_EXIT=$?

          if [ $PYTHON_EXIT -ne 0 ]; then
            echo "Python script failed with exit code $PYTHON_EXIT"
            cat output.txt
            exit 1
          fi

          # Extract operator response
          RESPONSE=$(sed -n '/OPERATOR_RESPONSE_START/,/OPERATOR_RESPONSE_END/p' output.txt | sed '1d;$d')

          # Save to file for multiline output
          echo "$RESPONSE" > response.txt

          # Check if response is empty
          if [ ! -s response.txt ]; then
            echo "ERROR: Response is empty"
            cat output.txt
            exit 1
          fi

      - name: Reply to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body-file response.txt

      - name: Close the call
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ github.event.issue.number }} --comment "ðŸ“ž *Call ended. Thank you for calling.*"

      - name: File the call log
        run: |
          git config user.name "The Operator"
          git config user.email "operator@thefactoryx.art"
          git add -A
          git diff --staged --quiet || git commit -m "ðŸ“ž Call #${{ github.event.issue.number }} recorded"
          git push
